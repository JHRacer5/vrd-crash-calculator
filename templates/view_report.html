{% extends "base.html" %}

{% block title %}Report #{{ report_id }} - VRD Racing{% endblock %}
{% block page_title %}Crash Report #{{ report_id }}{% endblock %}

{% block topbar_actions %}
<a href="/reports" class="btn btn-secondary">
    <span>‚Üê</span>
    <span>Back to Reports</span>
</a>
<button class="btn btn-secondary" onclick="window.print()">
    <span>üñ®Ô∏è</span>
    <span>Print</span>
</button>
<button class="btn btn-secondary" onclick="exportToCSV()">
    <span>üì•</span>
    <span>Export</span>
</button>
<button class="btn btn-primary" onclick="toggleEditMode()" id="editBtn">
    <span>‚úèÔ∏è</span>
    <span>Edit</span>
</button>
{% endblock %}

{% block content %}
<!-- Loading State -->
<div id="loadingState" class="card" style="text-align: center; padding: 60px;">
    <div class="loading" style="margin: 0 auto 20px;"></div>
    <div class="text-muted">Loading report...</div>
</div>

<!-- Main Content (Hidden until loaded) -->
<div id="mainContent" style="display: none;">
    <!-- Total Display -->
    <div
        style="background: linear-gradient(135deg, var(--racing-red), var(--racing-red-dark)); padding: 35px; border-radius: var(--radius-lg); margin-bottom: 30px; text-align: center; box-shadow: var(--glow-red);">
        <div
            style="font-size: 14px; font-weight: 600; margin-bottom: 10px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1.5px;">
            Total Estimated Damage</div>
        <div style="font-size: 54px; font-weight: 800;" id="totalAmount">$0.00</div>
    </div>

    <!-- Report Information -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Report Information</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span class="badge badge-success" id="reportStatusBadge">Active</span>
                <span class="text-muted" style="font-size: 13px;" id="reportDate"></span>
                <button class="btn btn-secondary btn-sm" id="markReviewedBtn" onclick="markAsReviewed()"
                    style="display: none;">
                    <span>‚úì</span>
                    <span>Mark as Reviewed</span>
                </button>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Driver Name</label>
                <input type="text" id="driver" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" id="date" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">Chassis</label>
                <input type="text" id="chassis" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">Event</label>
                <input type="text" id="event" class="form-input">
            </div>

            <div class="form-group full-width">
                <label class="form-label">Accident Damage Description</label>
                <textarea id="accidentDamage" class="form-textarea" rows="4"></textarea>
            </div>
        </div>

        <div id="editActions"
            style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); justify-content: flex-end; gap: 12px;">
            <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
            <button class="btn btn-primary" onclick="saveChanges()">
                <span>üíæ</span>
                <span>Save Changes</span>
            </button>
        </div>
    </div>

    <!-- Parts List -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Parts List <span class="text-muted" style="font-size: 14px; font-weight: 400;"
                    id="partsCount"></span></h2>
            <button class="btn btn-secondary btn-sm" onclick="addNewPart()" id="addPartBtn" style="display: none;">
                <span>‚ûï</span>
                <span>Add Part</span>
            </button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Part Number</th>
                        <th>Part Description</th>
                        <th>Likelihood</th>
                        <th>Price (USD)</th>
                        <th>Qty</th>
                        <th>Total</th>
                        <th id="actionsHeader" style="display: none;">Actions</th>
                    </tr>
                </thead>
                <tbody id="partsTable">
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const reportId = {{ report_id }};
    let report = null;
    let originalReport = null; // Keep a copy for cancel
    let editMode = false;
    const likelihoodOptions = ["Highly Likely", "Likely", "Possible", "Unlikely"];

    async function loadReport() {
        try {
            const response = await fetch(`/api/reports/${reportId}`);
            report = await response.json();
            originalReport = JSON.parse(JSON.stringify(report)); // Deep copy

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            displayReport();
            setReadOnlyMode(); // Start in read-only mode
        } catch (error) {
            console.error('Error loading report:', error);
            document.getElementById('loadingState').innerHTML = `
                <div style="text-align: center; padding: 60px; color: var(--text-error);">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <div>Failed to load report. <a href="/reports" style="color: var(--racing-red);">Back to reports</a></div>
                </div>
            `;
        }
    }

    function displayReport() {
        // Update fields
        document.getElementById('driver').value = report.driver || '';
        document.getElementById('date').value = report.date || '';
        document.getElementById('chassis').value = report.chassis || '';
        document.getElementById('event').value = report.event || '';
        document.getElementById('accidentDamage').value = report.accident_damage || '';

        // Update total
        document.getElementById('totalAmount').textContent = formatCurrency(report.total || 0);

        // Update report date
        const created = new Date(report.created_at);
        document.getElementById('reportDate').textContent = `Created ${created.toLocaleDateString()}`;

        // Update status badge
        const statusBadge = document.getElementById('reportStatusBadge');
        const status = report.status || 'active';
        statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        statusBadge.className = 'badge';

        if (status === 'pending') {
            statusBadge.classList.add('badge-orange');
            document.getElementById('markReviewedBtn').style.display = 'inline-flex';
        } else if (status === 'active') {
            statusBadge.classList.add('badge-red');
            document.getElementById('markReviewedBtn').style.display = 'inline-flex';
        } else if (status === 'reviewed') {
            statusBadge.classList.add('badge-success');
            document.getElementById('markReviewedBtn').style.display = 'none';
        }

        // Update parts count
        document.getElementById('partsCount').textContent = `(${report.parts.length} ${report.parts.length === 1 ? 'part' : 'parts'})`;

        // Display parts
        renderParts();
    }

    function setReadOnlyMode() {
        const inputs = document.querySelectorAll('#driver, #date, #chassis, #event, #accidentDamage');
        inputs.forEach(input => {
            input.disabled = true;
            input.style.background = 'var(--bg-tertiary)';
            input.style.borderColor = 'var(--border-color)';
            input.style.cursor = 'not-allowed';
            input.style.opacity = '0.7';
        });
    }

    function setEditMode() {
        const inputs = document.querySelectorAll('#driver, #date, #chassis, #event, #accidentDamage');
        inputs.forEach(input => {
            input.disabled = false;
            input.style.background = 'var(--bg-tertiary)';
            input.style.borderColor = 'var(--border-color)';
            input.style.cursor = 'text';
            input.style.opacity = '1';
        });
    }

    function renderParts() {
        const tbody = document.getElementById('partsTable');

        if (!report.parts || report.parts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        ${editMode ? 'No parts yet. Click "Add Part" to get started.' : 'No parts in this report'}
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = report.parts.map((part, index) => `
            <tr>
                <td>${editMode ? `
                    <input type="text" value="${escapeHtml(part.part_number || '')}" onchange="updatePart(${index}, 'part_number', this.value)" class="form-input" style="padding: 8px 12px; font-size: 13px;">
                ` : escapeHtml(part.part_number || 'N/A')}</td>
                <td>${editMode ? `
                    <input type="text" value="${escapeHtml(part.part || '')}" onchange="updatePart(${index}, 'part', this.value)" class="form-input" style="padding: 8px 12px; font-size: 13px;">
                ` : escapeHtml(part.part || 'N/A')}</td>
                <td>${editMode ? `
                    <select onchange="updatePart(${index}, 'likelihood', this.value)" class="form-select" style="padding: 8px 12px; font-size: 13px;">
                        ${likelihoodOptions.map(opt => `<option value="${opt}" ${opt === part.likelihood ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                ` : `<span class="badge badge-${getLikelihoodBadge(part.likelihood)}">${part.likelihood || 'N/A'}</span>`}</td>
                <td>${editMode ? `
                    <input type="number" value="${part.price || ''}" onchange="updatePart(${index}, 'price', this.value)" class="form-input" style="padding: 8px 12px; font-size: 13px;" min="0" step="0.01">
                ` : (part.price ? formatCurrency(part.price) : 'N/A')}</td>
                <td>${editMode ? `
                    <input type="number" value="${part.qty || 1}" onchange="updatePart(${index}, 'qty', this.value)" class="form-input" style="padding: 8px 12px; font-size: 13px;" min="1" step="1">
                ` : (part.qty || 'N/A')}</td>
                <td><strong class="text-error">${part.total ? formatCurrency(part.total) : '$0.00'}</strong></td>
                ${editMode ? `
                    <td><button class="btn btn-secondary btn-sm btn-icon" onclick="deletePart(${index})" title="Delete">üóëÔ∏è</button></td>
                ` : ''}
            </tr>
        `).join('');
    }

    function getLikelihoodBadge(likelihood) {
        const map = {
            'Highly Likely': 'red',
            'Likely': 'orange',
            'Possible': 'yellow',
            'Unlikely': 'gray'
        };
        return map[likelihood] || 'gray';
    }

    function toggleEditMode() {
        editMode = !editMode;

        if (editMode) {
            setEditMode();
        } else {
            setReadOnlyMode();
        }

        // Toggle edit actions
        document.getElementById('editActions').style.display = editMode ? 'flex' : 'none';
        document.getElementById('addPartBtn').style.display = editMode ? 'inline-flex' : 'none';
        document.getElementById('actionsHeader').style.display = editMode ? 'table-cell' : 'none';

        // Update edit button
        const editBtn = document.getElementById('editBtn');
        if (editMode) {
            editBtn.innerHTML = '<span>üëÅÔ∏è</span><span>View Mode</span>';
            editBtn.classList.remove('btn-primary');
            editBtn.classList.add('btn-secondary');
            showToast('Edit Mode', 'You can now edit all fields', 'success');
        } else {
            editBtn.innerHTML = '<span>‚úèÔ∏è</span><span>Edit</span>';
            editBtn.classList.remove('btn-secondary');
            editBtn.classList.add('btn-primary');
        }

        renderParts();
    }

    function cancelEdit() {
        // Restore original data
        report = JSON.parse(JSON.stringify(originalReport));
        displayReport();
        toggleEditMode();
        showToast('Cancelled', 'Changes discarded', 'success');
    }

    function updatePart(index, field, value) {
        if (field === 'price') {
            report.parts[index][field] = parseFloat(value) || 0;
            report.parts[index].total = report.parts[index].price * (report.parts[index].qty || 1);
        } else if (field === 'qty') {
            report.parts[index][field] = parseInt(value) || 1;
            report.parts[index].total = (report.parts[index].price || 0) * report.parts[index].qty;
        } else {
            report.parts[index][field] = value;
        }

        // Recalculate total
        report.total = report.parts.reduce((sum, p) => sum + (p.total || 0), 0);
        document.getElementById('totalAmount').textContent = formatCurrency(report.total);

        renderParts();
    }

    function deletePart(index) {
        showModal(
            'Delete Part',
            `Are you sure you want to remove this part?`,
            () => {
                report.parts.splice(index, 1);
                report.total = report.parts.reduce((sum, p) => sum + (p.total || 0), 0);
                document.getElementById('totalAmount').textContent = formatCurrency(report.total);
                document.getElementById('partsCount').textContent = `(${report.parts.length} ${report.parts.length === 1 ? 'part' : 'parts'})`;
                renderParts();
                showToast('Success', 'Part removed', 'success');
            }
        );
    }

    function addNewPart() {
        report.parts.push({
            part_number: '',
            part: '',
            likelihood: 'Possible',
            price: 0,
            qty: 1,
            total: 0
        });
        document.getElementById('partsCount').textContent = `(${report.parts.length} ${report.parts.length === 1 ? 'part' : 'parts'})`;
        renderParts();
        showToast('Success', 'New part added', 'success');
    }

    async function saveChanges() {
        // Validate
        const driver = document.getElementById('driver').value.trim();
        const date = document.getElementById('date').value;
        const chassis = document.getElementById('chassis').value.trim(); // Added chassis

        if (!driver) {
            showToast('Error', 'Driver name is required', 'error');
            return;
        }

        if (!date) {
            showToast('Error', 'Date is required', 'error');
            return;
        }

        const reportData = {
            driver,
            date,
            chassis: chassis, // Added chassis
            event: document.getElementById('event').value.trim(),
            accident_damage: document.getElementById('accidentDamage').value.trim(),
            parts: report.parts.map(p => ({
                part_number: p.part_number || '',
                part: p.part || '',
                likelihood: p.likelihood || 'Possible',
                price: parseFloat(p.price) || 0,
                qty: parseInt(p.qty) || 1
            }))
        };

        try {
            const response = await fetch(`/api/reports/${reportId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reportData)
            });

            const result = await response.json();

            if (result.success) {
                showToast('Success', 'Report updated successfully', 'success');
                // Reload to get fresh data
                await loadReport();
                editMode = true; // Set to true before toggle so it goes to false
                toggleEditMode();
            } else {
                showToast('Error', result.error || 'Failed to update report', 'error');
            }
        } catch (error) {
            console.error('Error saving report:', error);
            showToast('Error', 'Failed to save changes', 'error');
        }
    }

    function exportToCSV() {
        let csv = 'VRD Racing - Crash Report\n\n';
        csv += 'Report Information\n';
        csv += `Report ID,${reportId}\n`;
        csv += `Driver,${escapeCSV(report.driver)}\n`;
        csv += `Date,${report.date}\n`;
        csv += `Chassis,${escapeCSV(report.chassis)}\n`;
        csv += `Event,${escapeCSV(report.event)}\n`;
        csv += `Accident Damage,${escapeCSV(report.accident_damage)}\n`;
        csv += `Total (USD),${report.total}\n\n`;
        csv += 'Parts List\n';
        csv += 'Part Number,Part,Likelihood,Price,Qty,Total\n';

        report.parts.forEach(part => {
            csv += `${escapeCSV(part.part_number)},${escapeCSV(part.part)},${escapeCSV(part.likelihood)},${part.price || 0},${part.qty || 1},${part.total || 0}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `VRD_Crash_Report_${reportId}_${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);

        showToast('Success', 'Report exported successfully', 'success');
    }

    function escapeCSV(str) {
        if (str === null || str === undefined) return '';
        str = String(str);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function markAsReviewed() {
        showModal(
            'Mark as Reviewed',
            'Mark this report as reviewed? This indicates the report has been finalized and approved.',
            async () => {
                try {
                    const response = await fetch(`/api/reports/${reportId}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'reviewed' })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast('Success', 'Report marked as reviewed', 'success');
                        await loadReport();
                    } else {
                        showToast('Error', result.error || 'Failed to update status', 'error');
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    showToast('Error', 'Failed to update status', 'error');
                }
            }
        );
    }

    // Load report on page load
    loadReport();
</script>
{% endblock %}